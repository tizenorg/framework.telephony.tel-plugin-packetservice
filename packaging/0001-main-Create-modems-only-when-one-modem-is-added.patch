From ddb37eaa4cb56a44fa2531e5ae828f3a84eaa49b Mon Sep 17 00:00:00 2001
From: Guillaume Zajac <guillaume.zajac@linux.intel.com>
Date: Wed, 10 Oct 2012 16:50:27 +0200
Subject: [PATCH 1/3] main: Create modems only when one modem is added
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 8bit

---
 src/main.c |   17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/main.c b/src/main.c
index c07a1e1..5c4e27b 100644
--- a/src/main.c
+++ b/src/main.c
@@ -34,6 +34,18 @@ static gboolean on_load()
 	return TRUE;
 }
 
+static enum tcore_hook_return __on_hook_modem_added(Server *s, CoreObject *source,
+		enum tcore_notification_command command, unsigned int data_len, void *data, void *user_data)
+{
+	gpointer *master = user_data;
+
+	dbg("modem added event called");
+
+	_ps_master_create_modems(master);
+
+	return TCORE_HOOK_RETURN_CONTINUE;
+}
+
 static gboolean on_init(TcorePlugin *p)
 {
 	gpointer *master;
@@ -57,7 +69,10 @@ static gboolean on_init(TcorePlugin *p)
 	}
 
 	master = _ps_master_create_master(conn, p);
-	rv = _ps_master_create_modems(master);
+
+	tcore_server_add_notification_hook(tcore_plugin_ref_server(p),
+						TNOTI_MODEM_ADDED,
+						__on_hook_modem_added, master);
 
 	dbg("initialized PacketService plugin!");
 	return TRUE;
-- 
1.7.10.4

